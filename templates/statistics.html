{% extends 'base.html' %}

{% block page_title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤{% endblock %}
{% block page_description %}–ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π —É—á–µ–Ω–∏–∫–æ–≤ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏{% endblock %}

{% block content %}

<!-- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ç–æ–∫–æ–≤ (–ø–µ—Ä–≤–∞—è, –±–æ–ª—å—à–∞—è) -->
{% if transitions %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="color: var(--color-accent-primary); margin: 0;">üåä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ç–æ–∫–æ–≤ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</h2>

        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none;">
            <input type="checkbox" id="toggleNames" onchange="toggleStudentNames()"
                   style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--color-accent-primary);">
            <span style="font-size: 15px; font-weight: 500; color: var(--color-text-primary);">
                –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∞–º–∏–ª–∏–∏ —É—á–µ–Ω–∏–∫–æ–≤
            </span>
        </label>
    </div>

    <div style="background: var(--color-bg-secondary); padding: 32px; border-radius: 16px; border: 1px solid var(--color-border); overflow-x: auto;">
        <svg id="flowDiagram" width="100%" height="650" viewBox="0 0 1200 650" style="max-width: 100%;">
            <!-- –î–µ–∫–∞–±—Ä—å (—Å–ª–µ–≤–∞) -->
            <text x="180" y="40" font-size="24" font-weight="700" fill="var(--color-text-primary)">16 –¥–µ–∫–∞–±—Ä—è 2025</text>

            <!-- –ì—Ä—É–ø–ø—ã –¥–µ–∫–∞–±—Ä—è -->
            <rect x="80" y="80" width="200" height="70" rx="12" fill="#E3F2FD" stroke="#1976D2" stroke-width="3"/>
            <text x="180" y="120" text-anchor="middle" font-size="20" font-weight="700" fill="#1976D2">–ì—Ä—É–ø–ø–∞ 1</text>
            <text x="180" y="140" text-anchor="middle" font-size="14" fill="#1565C0">–†–µ–Ω–∫–∞—Å –ò.–ê.</text>

            <rect x="80" y="170" width="200" height="70" rx="12" fill="#F3E5F5" stroke="#7B1FA2" stroke-width="3"/>
            <text x="180" y="210" text-anchor="middle" font-size="20" font-weight="700" fill="#7B1FA2">–ì—Ä—É–ø–ø–∞ 2</text>
            <text x="180" y="230" text-anchor="middle" font-size="14" fill="#6A1B9A">–ö—Ä–µ—Å—Ç–Ω–∏–∫–æ–≤–∞ –ï.–í.</text>

            <rect x="80" y="260" width="200" height="70" rx="12" fill="#E8F5E9" stroke="#388E3C" stroke-width="3"/>
            <text x="180" y="300" text-anchor="middle" font-size="20" font-weight="700" fill="#388E3C">–ì—Ä—É–ø–ø–∞ 2.1</text>
            <text x="180" y="320" text-anchor="middle" font-size="14" fill="#2E7D32">–í–∏—Ç—Ä–∏—á–µ–Ω–∫–æ –í.–≠.</text>

            <rect x="80" y="350" width="200" height="70" rx="12" fill="#FFF3E0" stroke="#F57C00" stroke-width="3"/>
            <text x="180" y="390" text-anchor="middle" font-size="20" font-weight="700" fill="#F57C00">–ì—Ä—É–ø–ø–∞ 2.2</text>
            <text x="180" y="410" text-anchor="middle" font-size="14" fill="#E65100">–®—É–ª—è–µ–≤ –ú.–ò.</text>

            <rect x="80" y="440" width="200" height="70" rx="12" fill="#FCE4EC" stroke="#C2185B" stroke-width="3"/>
            <text x="180" y="480" text-anchor="middle" font-size="20" font-weight="700" fill="#C2185B">–ì—Ä—É–ø–ø–∞ 3</text>
            <text x="180" y="500" text-anchor="middle" font-size="14" fill="#880E4F">–§–∏—Å–µ–Ω–∫–æ –ï.–ú.</text>

            <!-- –Ø–Ω–≤–∞—Ä—å (—Å–ø—Ä–∞–≤–∞) -->
            <text x="920" y="40" font-size="24" font-weight="700" fill="var(--color-text-primary)">12 —è–Ω–≤–∞—Ä—è 2026</text>

            <!-- –ì—Ä—É–ø–ø—ã —è–Ω–≤–∞—Ä—è -->
            <rect x="920" y="80" width="200" height="70" rx="12" fill="#E3F2FD" stroke="#1976D2" stroke-width="3"/>
            <text x="1020" y="120" text-anchor="middle" font-size="20" font-weight="700" fill="#1976D2">–ì—Ä—É–ø–ø–∞ 1</text>
            <text x="1020" y="140" text-anchor="middle" font-size="14" fill="#1565C0">–†–µ–Ω–∫–∞—Å –ò.–ê.</text>

            <rect x="920" y="170" width="200" height="70" rx="12" fill="#F3E5F5" stroke="#7B1FA2" stroke-width="3"/>
            <text x="1020" y="210" text-anchor="middle" font-size="20" font-weight="700" fill="#7B1FA2">–ì—Ä—É–ø–ø–∞ 2</text>
            <text x="1020" y="230" text-anchor="middle" font-size="14" fill="#6A1B9A">–ö—Ä–µ—Å—Ç–Ω–∏–∫–æ–≤–∞ –ï.–í.</text>

            <rect x="920" y="260" width="200" height="70" rx="12" fill="#E8F5E9" stroke="#388E3C" stroke-width="3"/>
            <text x="1020" y="300" text-anchor="middle" font-size="20" font-weight="700" fill="#388E3C">–ì—Ä—É–ø–ø–∞ 2.1</text>
            <text x="1020" y="320" text-anchor="middle" font-size="14" fill="#2E7D32">–í–∏—Ç—Ä–∏—á–µ–Ω–∫–æ –í.–≠.</text>

            <rect x="920" y="350" width="200" height="70" rx="12" fill="#FFF3E0" stroke="#F57C00" stroke-width="3"/>
            <text x="1020" y="390" text-anchor="middle" font-size="20" font-weight="700" fill="#F57C00">–ì—Ä—É–ø–ø–∞ 2.2</text>
            <text x="1020" y="410" text-anchor="middle" font-size="14" fill="#E65100">–®—É–ª—è–µ–≤ –ú.–ò.</text>

            <rect x="920" y="440" width="200" height="70" rx="12" fill="#FCE4EC" stroke="#C2185B" stroke-width="3"/>
            <text x="1020" y="480" text-anchor="middle" font-size="20" font-weight="700" fill="#C2185B">–ì—Ä—É–ø–ø–∞ 3</text>
            <text x="1020" y="500" text-anchor="middle" font-size="14" fill="#880E4F">–§–∏—Å–µ–Ω–∫–æ –ï.–ú.</text>

            <!-- –°—Ç—Ä–µ–ª–∫–∏ —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏ -->
            <defs>
                <marker id="arrow1" markerWidth="12" markerHeight="12" refX="10" refY="4" orient="auto">
                    <polygon points="0 0, 12 4, 0 8" fill="#FF6B35" />
                </marker>
                <marker id="arrow2" markerWidth="12" markerHeight="12" refX="10" refY="4" orient="auto">
                    <polygon points="0 0, 12 4, 0 8" fill="#4CAF50" />
                </marker>
                <marker id="arrow3" markerWidth="12" markerHeight="12" refX="10" refY="4" orient="auto">
                    <polygon points="0 0, 12 4, 0 8" fill="#2196F3" />
                </marker>
                <marker id="arrow4" markerWidth="12" markerHeight="12" refX="10" refY="4" orient="auto">
                    <polygon points="0 0, 12 4, 0 8" fill="#9C27B0" />
                </marker>
                <marker id="arrow5" markerWidth="12" markerHeight="12" refX="10" refY="4" orient="auto">
                    <polygon points="0 0, 12 4, 0 8" fill="#FF5722" />
                </marker>
                <marker id="arrow6" markerWidth="12" markerHeight="12" refX="10" refY="4" orient="auto">
                    <polygon points="0 0, 12 4, 0 8" fill="#FF9800" />
                </marker>
            </defs>

            <!-- 2 ‚Üí 1 (–ö–æ—Ä–æ–ª—å –î–µ–Ω–∏—Å) -->
            <path d="M 280 205 Q 600 115 920 115" fill="none" stroke="#FF6B35" stroke-width="3" opacity="0.8" marker-end="url(#arrow1)"/>
            <text x="600" y="105" text-anchor="middle" font-size="14" fill="#FF6B35" font-weight="700">1</text>
            <text class="student-label" x="600" y="125" text-anchor="middle" font-size="13" fill="#FF6B35" font-weight="600" style="display: none;">–ö–æ—Ä–æ–ª—å –î.</text>

            <!-- 2 ‚Üí 2.1 (–ê–±–µ–ª—é–∫, –†—ã–ª—å—Å–∫–∞—è) -->
            <path d="M 280 205 Q 600 295 920 295" fill="none" stroke="#4CAF50" stroke-width="4" opacity="0.8" marker-end="url(#arrow2)"/>
            <text x="600" y="285" text-anchor="middle" font-size="14" fill="#4CAF50" font-weight="700">2</text>
            <text class="student-label" x="600" y="305" text-anchor="middle" font-size="13" fill="#4CAF50" font-weight="600" style="display: none;">–ê–±–µ–ª—é–∫ –ú., –†—ã–ª—å—Å–∫–∞—è –≠.</text>

            <!-- 2.1 ‚Üí 2 (–õ–µ–π—Ç–µ—Å, –ú–∞—Ä—Ç–∏—Ä–æ—Å—è–Ω, –ù–æ–≤–æ–∂–µ–Ω–æ–≤) -->
            <path d="M 280 295 Q 600 205 920 205" fill="none" stroke="#2196F3" stroke-width="5" opacity="0.8" marker-end="url(#arrow3)"/>
            <text x="600" y="195" text-anchor="middle" font-size="14" fill="#2196F3" font-weight="700">3</text>
            <text class="student-label" x="600" y="215" text-anchor="middle" font-size="12" fill="#2196F3" font-weight="600" style="display: none;">–õ–µ–π—Ç–µ—Å –ú., –ú–∞—Ä—Ç–∏—Ä–æ—Å—è–Ω –î., –ù–æ–≤–æ–∂–µ–Ω–æ–≤ –Æ.</text>

            <!-- 2.1 ‚Üí 2.2 (–ú–æ–ª–æ–¥—Ü–æ–≤) -->
            <path d="M 280 295 Q 600 385 920 385" fill="none" stroke="#9C27B0" stroke-width="3" opacity="0.8" marker-end="url(#arrow4)"/>
            <text x="600" y="375" text-anchor="middle" font-size="14" fill="#9C27B0" font-weight="700">1</text>
            <text class="student-label" x="600" y="395" text-anchor="middle" font-size="13" fill="#9C27B0" font-weight="600" style="display: none;">–ú–æ–ª–æ–¥—Ü–æ–≤ –õ.</text>

            <!-- 2.2 ‚Üí 3 (–õ–æ–≥—É–Ω–æ–≤–∞) -->
            <path d="M 280 385 Q 600 475 920 475" fill="none" stroke="#FF5722" stroke-width="3" opacity="0.8" marker-end="url(#arrow5)"/>
            <text x="600" y="465" text-anchor="middle" font-size="14" fill="#FF5722" font-weight="700">1</text>
            <text class="student-label" x="600" y="485" text-anchor="middle" font-size="13" fill="#FF5722" font-weight="600" style="display: none;">–õ–æ–≥—É–Ω–æ–≤–∞ –ê.</text>

            <!-- 3 ‚Üí 2.2 (–ü–∞—Ç–∏–Ω–∞) -->
            <path d="M 280 475 Q 600 385 920 385" fill="none" stroke="#FF9800" stroke-width="3" opacity="0.8" marker-end="url(#arrow6)"/>
            <text x="600" y="410" text-anchor="middle" font-size="14" fill="#FF9800" font-weight="700">1</text>
            <text class="student-label" x="600" y="430" text-anchor="middle" font-size="13" fill="#FF9800" font-weight="600" style="display: none;">–ü–∞—Ç–∏–Ω–∞ –ê.</text>
        </svg>

        <div style="text-align: center; margin-top: 24px; color: var(--color-text-muted); font-size: 14px;">
            üí° <strong>–¢–æ–ª—â–∏–Ω–∞ —Å—Ç—Ä–µ–ª–∫–∏</strong> –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤. –í–∫–ª—é—á–∏—Ç–µ —á–µ–∫–±–æ–∫—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–º–∏–ª–∏–π.
        </div>
    </div>
</div>

<script>
function toggleStudentNames() {
    const checkbox = document.getElementById('toggleNames');
    const labels = document.querySelectorAll('.student-label');

    labels.forEach(label => {
        label.style.display = checkbox.checked ? 'block' : 'none';
    });
}
</script>
{% endif %}

<!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="card">
    <h2 style="color: var(--color-accent-primary); margin-bottom: 24px;">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); padding: 20px; border-radius: 12px; border: 1px solid #90CAF9;">
            <div style="font-size: 32px; font-weight: 700; color: #1976D2; margin-bottom: 8px;">{{ total_transitions }}</div>
            <div style="color: #1565C0; font-size: 14px; font-weight: 500;">–í—Å–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</div>
        </div>

        <div style="background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); padding: 20px; border-radius: 12px; border: 1px solid #CE93D8;">
            <div style="font-size: 32px; font-weight: 700; color: #7B1FA2; margin-bottom: 8px;">{{ group_stats|length }}</div>
            <div style="color: #6A1B9A; font-size: 14px; font-weight: 500;">–ê–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø</div>
        </div>

        <div style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); padding: 20px; border-radius: 12px; border: 1px solid #A5D6A7;">
            <div style="font-size: 32px; font-weight: 700; color: #388E3C; margin-bottom: 8px;">{{ transitions|length }}</div>
            <div style="color: #2E7D32; font-size: 14px; font-weight: 500;">–£—á–µ–Ω–∏–∫–æ–≤ —Å –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏</div>
        </div>
    </div>
</div>

<!-- –¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≥—Ä—É–ø–ø–∞–º -->
<div class="card">
    <h2 style="color: var(--color-accent-primary); margin-bottom: 20px;">üë• –¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</h2>

    <div style="display: grid; gap: 16px;">
        {% for stat in group_stats %}
        <div style="background: var(--color-bg-secondary); padding: 16px; border-radius: 10px; border: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 18px; font-weight: 600; color: var(--color-text-primary); margin-bottom: 4px;">
                    –ì—Ä—É–ø–ø–∞ {{ stat.group.number }}
                </div>
                <div style="color: var(--color-text-muted); font-size: 14px;">
                    {{ stat.teacher }}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 28px; font-weight: 700; color: var(--color-accent-primary);">
                    {{ stat.current_count }}
                </div>
                <div style="color: var(--color-text-muted); font-size: 12px;">
                    —É—á–µ–Ω–∏–∫–æ–≤
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ü–µ—Ä–µ—Ö–æ–¥—ã –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º -->
{% if transitions_by_direction %}
<div class="card">
    <h2 style="color: var(--color-accent-primary); margin-bottom: 20px;">üîÑ –ü–µ—Ä–µ—Ö–æ–¥—ã –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</h2>

    <div style="display: grid; gap: 12px;">
        {% for direction, count in transitions_by_direction.items %}
        <div style="background: var(--color-blue-light); padding: 14px 18px; border-radius: 8px; border-left: 4px solid var(--color-accent-primary); display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 16px; font-weight: 500; color: var(--color-text-primary);">
                {{ direction }}
            </div>
            <div style="background: var(--color-accent-primary); color: white; padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 14px;">
                {{ count }} {% if count == 1 %}—É—á–µ–Ω–∏–∫{% elif count < 5 %}—É—á–µ–Ω–∏–∫–∞{% else %}—É—á–µ–Ω–∏–∫–æ–≤{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ -->
{% if transitions %}
<div class="card">
    <h2 style="color: var(--color-accent-primary); margin-bottom: 20px;">üìã –î–µ—Ç–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</h2>

    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--color-bg-secondary); border-bottom: 2px solid var(--color-border);">
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--color-text-secondary); font-size: 13px;">‚Ññ</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--color-text-secondary); font-size: 13px;">–£—á–µ–Ω–∏–∫</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--color-text-secondary); font-size: 13px;">–ü–µ—Ä–µ—Ö–æ–¥</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--color-text-secondary); font-size: 13px;">–î–∞—Ç–∞</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--color-text-secondary); font-size: 13px;">–ü—Ä–∏—á–∏–Ω–∞</th>
                </tr>
            </thead>
            <tbody>
                {% for transition in transitions %}
                <tr style="border-bottom: 1px solid var(--color-border); transition: background 0.2s;" onmouseover="this.style.background='var(--color-blue-light)'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 14px; color: var(--color-text-muted); font-size: 14px;">{{ forloop.counter }}</td>
                    <td style="padding: 14px; font-weight: 500; color: var(--color-text-primary); font-size: 14px;">
                        {{ transition.student.full_name }}
                    </td>
                    <td style="padding: 14px; font-size: 14px;">
                        <span style="display: inline-flex; align-items: center; gap: 8px;">
                            <span style="background: rgba(255, 107, 53, 0.15); color: #FF6B35; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                –ì—Ä—É–ø–ø–∞ {{ transition.from_group.number }}
                            </span>
                            <span style="color: var(--color-text-muted);">‚Üí</span>
                            <span style="background: rgba(76, 175, 80, 0.15); color: #4CAF50; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
                                –ì—Ä—É–ø–ø–∞ {{ transition.to_group.number }}
                            </span>
                        </span>
                    </td>
                    <td style="padding: 14px; color: var(--color-text-secondary); font-size: 14px;">
                        {{ transition.date|date:"d.m.Y" }}
                    </td>
                    <td style="padding: 14px; color: var(--color-text-muted); font-size: 13px; font-style: italic;">
                        {{ transition.reason }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card" style="text-align: center; padding: 48px 24px;">
    <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
    <h3 style="color: var(--color-text-secondary); font-weight: 500; margin-bottom: 8px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö</h3>
    <p style="color: var(--color-text-muted); font-size: 14px;">
        –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç <code style="background: var(--color-bg-secondary); padding: 4px 8px; border-radius: 4px;">add_december_history.py</code>
    </p>
</div>
{% endif %}

{% endblock %}
