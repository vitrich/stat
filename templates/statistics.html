{% extends 'base.html' %}

{% block page_title %}–ì—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —É—á–µ–Ω–∏–∫–æ–≤{% endblock %}
{% block page_description %}–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏{% endblock %}

{% block content %}

<style>
.student-checkbox {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
}

.student-checkbox:hover {
    background: var(--color-bg-secondary);
}

.student-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 12px;
    cursor: pointer;
    accent-color: var(--color-accent-primary);
}

.student-checkbox label {
    cursor: pointer;
    font-size: 15px;
    color: var(--color-text-primary);
    font-weight: 500;
}

#transitionsChart {
    border: 1px solid var(--color-border);
    border-radius: 12px;
    background: white;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--color-bg-secondary);
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

.btn {
    background: var(--color-accent-primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.2s;
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.btn--secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
}

.btn--secondary:hover {
    background: var(--color-border);
}
</style>

<!-- –í—ã–±–æ—Ä —É—á–µ–Ω–∏–∫–æ–≤ -->
<div class="card">
    <h2 style="color: var(--color-accent-primary); margin-bottom: 20px;">üë• –í—ã–±–æ—Ä —É—á–µ–Ω–∏–∫–æ–≤</h2>

    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
        <button onclick="selectAll()" class="btn btn--secondary">
            ‚úì –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö
        </button>
        <button onclick="deselectAll()" class="btn btn--secondary">
            ‚úó –°–Ω—è—Ç—å –≤—Å–µ—Ö
        </button>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px; max-height: 400px; overflow-y: auto; padding: 8px; background: var(--color-bg-secondary); border-radius: 8px;">
        {% for student in students_with_transitions %}
            <div class="student-checkbox">
                <input type="checkbox"
                       id="student_{{ student.id }}"
                       value="{{ student.id }}"
                       onchange="updateChart()">
                <label for="student_{{ student.id }}">
                    {{ student.name }}
                </label>
            </div>
        {% endfor %}
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
        <h2 style="color: var(--color-accent-primary); margin: 0;">üìä –ì—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏</h2>
        <div id="legend" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
    </div>

    <canvas id="transitionsChart" width="1200" height="600"></canvas>

    <div style="text-align: center; margin-top: 16px; color: var(--color-text-muted); font-size: 14px;">
        <strong>–û—Å—å X:</strong> –î–∞—Ç—ã | <strong>–û—Å—å Y:</strong> –ì—Ä—É–ø–ø—ã
    </div>
</div>

<script>
// –î–∞–Ω–Ω—ã–µ –∏–∑ Django
const studentsData = {{ students_json|safe }};

// –¶–≤–µ—Ç–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤
const colors = [
    '#FF6B35', '#4CAF50', '#2196F3', '#9C27B0', '#FF9800',
    '#E91E63', '#00BCD4', '#8BC34A', '#FFC107', '#673AB7',
    '#009688', '#FF5722', '#3F51B5', '#CDDC39', '#795548',
    '#607D8B', '#F44336', '#1976D2', '#388E3C', '#D32F2F'
];

function updateChart() {
    const canvas = document.getElementById('transitionsChart');
    const ctx = canvas.getContext('2d');

    // –û—á–∏—â–∞–µ–º canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤
    const selectedStudents = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => parseInt(cb.value));

    if (selectedStudents.length === 0) {
        ctx.fillStyle = '#999';
        ctx.font = '18px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞', canvas.width / 2, canvas.height / 2);
        document.getElementById('legend').innerHTML = '';
        return;
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
    const padding = 80;
    const chartWidth = canvas.width - padding * 2;
    const chartHeight = canvas.height - padding * 2;

    // –î–∞—Ç—ã (–æ—Å—å X)
    const dates = ['2025-09-01', '2025-12-16', '2026-01-12'];
    const dateLabels = ['1 —Å–µ–Ω—Ç—è–±—Ä—è', '16 –¥–µ–∫–∞–±—Ä—è', '12 —è–Ω–≤–∞—Ä—è'];

    // –ì—Ä—É–ø–ø—ã (–æ—Å—å Y)
    const groups = [1, 2, 2.1, 2.2, 3];
    const groupLabels = ['–ì—Ä—É–ø–ø–∞ 1', '–ì—Ä—É–ø–ø–∞ 2', '–ì—Ä—É–ø–ø–∞ 2.1', '–ì—Ä—É–ø–ø–∞ 2.2', '–ì—Ä—É–ø–ø–∞ 3'];

    // –†–∏—Å—É–µ–º –æ—Å–∏
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 2;

    // –û—Å—å Y
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, canvas.height - padding);
    ctx.stroke();

    // –û—Å—å X
    ctx.beginPath();
    ctx.moveTo(padding, canvas.height - padding);
    ctx.lineTo(canvas.width - padding, canvas.height - padding);
    ctx.stroke();

    // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–∏ Y (–≥—Ä—É–ø–ø—ã)
    ctx.fillStyle = '#333';
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'right';
    groups.forEach((group, i) => {
        const y = padding + (chartHeight / (groups.length - 1)) * (groups.length - 1 - i);
        ctx.fillText(groupLabels[i], padding - 10, y + 5);

        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(canvas.width - padding, y);
        ctx.stroke();
    });

    // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–∏ X (–¥–∞—Ç—ã)
    ctx.textAlign = 'center';
    dates.forEach((date, i) => {
        const x = padding + (chartWidth / (dates.length - 1)) * i;
        ctx.fillText(dateLabels[i], x, canvas.height - padding + 25);

        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, canvas.height - padding);
        ctx.stroke();
    });

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã –≤ Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É
    function groupToY(groupNum) {
        const index = groups.indexOf(groupNum);
        return padding + (chartHeight / (groups.length - 1)) * (groups.length - 1 - index);
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –≤ X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É
    function dateToX(date) {
        const index = dates.indexOf(date);
        return padding + (chartWidth / (dates.length - 1)) * index;
    }

    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
    const legend = document.getElementById('legend');
    legend.innerHTML = '';

    selectedStudents.forEach((studentId, index) => {
        const student = studentsData[studentId];
        if (!student) return;

        const color = colors[index % colors.length];

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–µ–≥–µ–Ω–¥—É
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.innerHTML = `
            <div class="legend-color" style="background: ${color};"></div>
            <span>${student.name}</span>
        `;
        legend.appendChild(legendItem);

        // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –∏—Å—Ç–æ—Ä–∏–∏
        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = 3;

        const history = student.history;

        // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
        for (let i = 0; i < history.length; i++) {
            const point = history[i];
            const x = dateToX(point.date);
            const y = groupToY(point.group);

            // –†–∏—Å—É–µ–º —Ç–æ—á–∫—É
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.fill();

            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–µ
            if (i < history.length - 1) {
                const nextPoint = history[i + 1];
                const nextX = dateToX(nextPoint.date);
                const nextY = groupToY(nextPoint.group);

                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(nextX, nextY);
                ctx.stroke();
            }
        }
    });
}

function selectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    updateChart();
}

function deselectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateChart();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.addEventListener('load', () => {
    updateChart();
});
</script>

{% endblock %}
