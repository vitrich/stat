{% extends 'base.html' %}

{% block page_title %}Статистика переходов{% endblock %}

{% block page_description %}Анализ динамики уровней учеников{% endblock %}

{% block content %}
    <style>
        .student-checkbox {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }

        .student-checkbox:hover {
            background: var(--color-bg-secondary);
        }

        .student-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: var(--color-accent-primary);
        }

        .student-checkbox label {
            cursor: pointer;
            font-size: 15px;
            color: var(--color-text-primary);
            font-weight: 500;
        }

        .transitionsChart {
            border: 1px solid var(--color-border);
            border-radius: 12px;
            background: #FFFFFF;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--color-bg-secondary);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .btn {
            background: var(--color-accent-primary);
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn--secondary {
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        .btn--secondary:hover {
            background: var(--color-border);
        }
    </style>

    <div class="card">
        <h2 style="color: var(--color-accent-primary); margin-bottom: 20px;">
            Статистика переходов
        </h2>

        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <button onclick="selectAll()" class="btn btn--secondary">Выбрать всех</button>
            <button onclick="deselectAll()" class="btn btn--secondary">Снять выделение</button>
        </div>

        <div style="
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding: 8px;
            background: var(--color-bg-secondary);
            border-radius: 8px;
        ">
            {% for student in students_with_transitions %}
                <div class="student-checkbox">
                    <input type="checkbox"
                           id="student_{{ student.id }}"
                           value="{{ student.id }}"
                           onchange="updateChart()">
                    <label for="student_{{ student.id }}">{{ student.name }}</label>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="card">
        <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        ">
            <h2 style="color: var(--color-accent-primary); margin: 0;">
                График переходов
            </h2>
            <div id="legend" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
        </div>

        <canvas id="transitionsChart" width="1200" height="600"></canvas>

        <div style="text-align: center; margin-top: 16px; color: var(--color-text-muted); font-size: 14px;">
            <strong>X</strong> — даты, <strong>Y</strong> — уровни (1, 2, 2.1, 2.2, 3)
        </div>
    </div>

    <script>
        const studentsData = {{ students_json|safe }};
        const colors = [
            "#FF6B35", "#4CAF50", "#2196F3", "#9C27B0", "#FF9800",
            "#E91E63", "#00BCD4", "#8BC34A", "#FFC107", "#673AB7",
            "#009688", "#FF5722", "#3F51B5", "#CDDC39", "#795548",
            "#607D8B", "#F44336", "#1976D2", "#388E3C", "#D32F2F"
        ];

        function updateChart() {
            const canvas = document.getElementById("transitionsChart");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const selectedStudents = Array.from(
                document.querySelectorAll("input[type='checkbox']:checked")
            ).map(cb => parseInt(cb.value));

            if (selectedStudents.length === 0) {
                ctx.fillStyle = "#999";
                ctx.font = "18px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText("Выберите хотя бы одного ученика", canvas.width / 2, canvas.height / 2);
                document.getElementById("legend").innerHTML = "";
                return;
            }

            const padding = 80;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;

            const dates = [];
            const dateLabels = [];
            const allDates = new Set();

            Object.values(studentsData).forEach(student => {
                student.history.forEach(point => allDates.add(point.date));
            });

            const sortedDates = Array.from(allDates).sort();
            sortedDates.forEach(dateStr => {
                dates.push(dateStr);
                const date = new Date(dateStr);
                const months = ["янв", "фев", "мар", "апр", "май", "июн",
                    "июл", "авг", "сен", "окт", "ноя", "дек"];
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                dateLabels.push(`${day} ${month} ${year}`);
            });

            const groups = [1, 2, 2.1, 2.2, 3];
            const groupLabels = ["1", "2", "2.1", "2.2", "3"];

            // Axes
            ctx.strokeStyle = "#ddd";
            ctx.lineWidth = 2;

            // Y-axis
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.stroke();

            // X-axis
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();

            // Y labels and horizontal grid
            ctx.fillStyle = "#333";
            ctx.font = "14px sans-serif";
            ctx.textAlign = "right";

            groups.forEach((group, i) => {
                const y = padding + chartHeight * (groups.length - 1 - i) / (groups.length - 1);
                ctx.fillText(groupLabels[i], padding - 10, y + 5);

                ctx.strokeStyle = "#f0f0f0";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            });

            // X labels and vertical grid
            ctx.textAlign = "center";
            dates.forEach((date, i) => {
                const x = padding + chartWidth * i / Math.max(dates.length - 1, 1);
                ctx.fillText(dateLabels[i], x, canvas.height - padding + 25);

                ctx.strokeStyle = "#f0f0f0";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, canvas.height - padding);
                ctx.stroke();
            });

            function groupToY(groupNum) {
                const index = groups.indexOf(groupNum);
                return padding + chartHeight * (groups.length - 1 - index) / (groups.length - 1);
            }

            function dateToX(date) {
                const index = dates.indexOf(date);
                return padding + chartWidth * index / Math.max(dates.length - 1, 1);
            }

            const legend = document.getElementById("legend");
            legend.innerHTML = "";

            selectedStudents.forEach((studentId, index) => {
                const student = studentsData[studentId];
                if (!student) return;

                const color = colors[index % colors.length];

                const legendItem = document.createElement("div");
                legendItem.className = "legend-item";
                legendItem.innerHTML =
                    `<div class="legend-color" style="background: ${color};"></div>` +
                    `<span>${student.name}</span>`;
                legend.appendChild(legendItem);

                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = 3;

                const history = student.history;
                for (let i = 0; i < history.length; i++) {
                    const point = history[i];
                    const x = dateToX(point.date);
                    const y = groupToY(point.group);

                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, Math.PI * 2);
                    ctx.fill();

                    if (i < history.length - 1) {
                        const nextPoint = history[i + 1];
                        const nextX = dateToX(nextPoint.date);
                        const nextY = groupToY(nextPoint.group);
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(nextX, nextY);
                        ctx.stroke();
                    }
                }
            });
        }

        function selectAll() {
            document.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = true);
            updateChart();
        }

        function deselectAll() {
            document.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
            updateChart();
        }

        window.addEventListener("load", updateChart);
    </script>
{% endblock %}
