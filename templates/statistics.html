{% extends 'base.html' %}

{% block page_title %}–ì—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —É—á–µ–Ω–∏–∫–æ–≤{% endblock %}
{% block page_description %}–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏{% endblock %}

{% block content %}

<style>
.student-checkbox {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
}

.student-checkbox:hover {
    background: var(--color-bg-secondary);
}

.student-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 12px;
    cursor: pointer;
    accent-color: var(--color-accent-primary);
}

.student-checkbox label {
    cursor: pointer;
    font-size: 15px;
    color: var(--color-text-primary);
    font-weight: 500;
}

#transitionsChart {
    border: 1px solid var(--color-border);
    border-radius: 12px;
    background: white;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--color-bg-secondary);
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}
</style>

<!-- –í—ã–±–æ—Ä —É—á–µ–Ω–∏–∫–æ–≤ -->
<div class="card">
    <h2 style="color: var(--color-accent-primary); margin-bottom: 20px;">üë• –í—ã–±–æ—Ä —É—á–µ–Ω–∏–∫–æ–≤</h2>

    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
        <button onclick="selectAll()" class="btn btn--secondary" style="padding: 8px 16px;">
            ‚úì –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö
        </button>
        <button onclick="deselectAll()" class="btn btn--secondary" style="padding: 8px 16px;">
            ‚úó –°–Ω—è—Ç—å –≤—Å–µ—Ö
        </button>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px; max-height: 400px; overflow-y: auto; padding: 8px; background: var(--color-bg-secondary); border-radius: 8px;">
        {% for transition in transitions %}
            {% if forloop.first or transition.student.id != transitions|slice:":forloop.counter0"|last.student.id %}
                <div class="student-checkbox">
                    <input type="checkbox"
                           id="student_{{ transition.student.id }}"
                           value="{{ transition.student.id }}"
                           onchange="updateChart()">
                    <label for="student_{{ transition.student.id }}">
                        {{ transition.student.full_name }}
                    </label>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: var(--color-accent-primary); margin: 0;">üìä –ì—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏</h2>
        <div id="legend" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
    </div>

    <canvas id="transitionsChart" width="1200" height="600"></canvas>

    <div style="text-align: center; margin-top: 16px; color: var(--color-text-muted); font-size: 14px;">
        <strong>–û—Å—å X:</strong> –î–∞—Ç—ã | <strong>–û—Å—å Y:</strong> –ì—Ä—É–ø–ø—ã
    </div>
</div>

<script>
// –î–∞–Ω–Ω—ã–µ –∏–∑ Django
const studentsData = {
    {% for transition in transitions %}
        {% if forloop.first or transition.student.id != transitions|slice:":forloop.counter0"|last.student.id %}
            {{ transition.student.id }}: {
                name: "{{ transition.student.full_name }}",
                history: []
            }{% if not forloop.last %},{% endif %}
        {% endif %}
    {% endfor %}
};

// –°–æ–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
{% for transition in transitions %}
    studentsData[{{ transition.student.id }}].history.push({
        date: "{{ transition.date|date:'Y-m-d' }}",
        fromGroup: {{ transition.from_group.number }},
        toGroup: {{ transition.to_group.number }}
    });
{% endfor %}

// –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
const allHistory = {{ history_by_date|safe }};

// –¶–≤–µ—Ç–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤
const colors = [
    '#FF6B35', '#4CAF50', '#2196F3', '#9C27B0', '#FF9800',
    '#E91E63', '#00BCD4', '#8BC34A', '#FFC107', '#673AB7',
    '#009688', '#FF5722', '#3F51B5', '#CDDC39', '#795548'
];

let chart = null;

function getGroupYPosition(groupNum) {
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–æ–º–µ—Ä –≥—Ä—É–ø–ø—ã –≤ –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –æ—Å–∏ Y
    const positions = {
        1: 5,
        2: 4,
        2.1: 3,
        2.2: 2,
        3: 1
    };
    return positions[groupNum] || 0;
}

function updateChart() {
    const canvas = document.getElementById('transitionsChart');
    const ctx = canvas.getContext('2d');

    // –û—á–∏—â–∞–µ–º canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤
    const selectedStudents = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => parseInt(cb.value));

    if (selectedStudents.length === 0) {
        ctx.fillStyle = '#999';
        ctx.font = '18px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞', canvas.width / 2, canvas.height / 2);
        document.getElementById('legend').innerHTML = '';
        return;
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
    const padding = 80;
    const chartWidth = canvas.width - padding * 2;
    const chartHeight = canvas.height - padding * 2;

    // –î–∞—Ç—ã (–æ—Å—å X)
    const dates = ['2025-09-01', '2025-12-16', '2026-01-12'];
    const dateLabels = ['1 —Å–µ–Ω—Ç—è–±—Ä—è', '16 –¥–µ–∫–∞–±—Ä—è', '12 —è–Ω–≤–∞—Ä—è'];

    // –ì—Ä—É–ø–ø—ã (–æ—Å—å Y)
    const groups = [1, 2, 2.1, 2.2, 3];
    const groupLabels = ['–ì—Ä—É–ø–ø–∞ 1', '–ì—Ä—É–ø–ø–∞ 2', '–ì—Ä—É–ø–ø–∞ 2.1', '–ì—Ä—É–ø–ø–∞ 2.2', '–ì—Ä—É–ø–ø–∞ 3'];

    // –†–∏—Å—É–µ–º –æ—Å–∏
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 2;

    // –û—Å—å Y
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, canvas.height - padding);
    ctx.stroke();

    // –û—Å—å X
    ctx.beginPath();
    ctx.moveTo(padding, canvas.height - padding);
    ctx.lineTo(canvas.width - padding, canvas.height - padding);
    ctx.stroke();

    // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–∏ Y (–≥—Ä—É–ø–ø—ã)
    ctx.fillStyle = '#333';
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'right';
    groups.forEach((group, i) => {
        const y = padding + (chartHeight / (groups.length - 1)) * (groups.length - 1 - i);
        ctx.fillText(groupLabels[i], padding - 10, y + 5);

        // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(canvas.width - padding, y);
        ctx.stroke();
    });

    // –ü–æ–¥–ø–∏—Å–∏ –æ—Å–∏ X (–¥–∞—Ç—ã)
    ctx.textAlign = 'center';
    dates.forEach((date, i) => {
        const x = padding + (chartWidth / (dates.length - 1)) * i;
        ctx.fillText(dateLabels[i], x, canvas.height - padding + 25);

        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, canvas.height - padding);
        ctx.stroke();
    });

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã –≤ Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É
    function groupToY(groupNum) {
        const index = groups.indexOf(groupNum);
        return padding + (chartHeight / (groups.length - 1)) * (groups.length - 1 - index);
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã –≤ X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É
    function dateToX(date) {
        const index = dates.indexOf(date);
        return padding + (chartWidth / (dates.length - 1)) * index;
    }

    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
    const legend = document.getElementById('legend');
    legend.innerHTML = '';

    selectedStudents.forEach((studentId, index) => {
        const student = studentsData[studentId];
        const color = colors[index % colors.length];

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–µ–≥–µ–Ω–¥—É
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.innerHTML = `
            <div class="legend-color" style="background: ${color};"></div>
            <span>${student.name}</span>
        `;
        legend.appendChild(legendItem);

        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —É—á–µ–Ω–∏–∫–∞ (–Ω—É–∂–Ω–æ –∏–∑ Django –ø–µ—Ä–µ–¥–∞—Ç—å)
        // –ü–æ–∫–∞ —Ä–∏—Å—É–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = 3;

        // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Å –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–æ–π
        // –í—Ä–µ–º–µ–Ω–Ω–æ —Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—Ö–æ–¥—ã
        student.history.forEach((transition, i) => {
            if (i > 0) {
                const prevTransition = student.history[i - 1];
                const x1 = dateToX(prevTransition.date);
                const y1 = groupToY(prevTransition.toGroup);
                const x2 = dateToX(transition.date);
                const y2 = groupToY(transition.toGroup);

                // –õ–∏–Ω–∏—è
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                // –¢–æ—á–∫–∏
                ctx.beginPath();
                ctx.arc(x1, y1, 6, 0, Math.PI * 2);
                ctx.fill();
            }
        });

        // –ü–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞
        if (student.history.length > 0) {
            const last = student.history[student.history.length - 1];
            const x = dateToX(last.date);
            const y = groupToY(last.toGroup);
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI * 2);
            ctx.fill();
        }
    });
}

function selectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    updateChart();
}

function deselectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateChart();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.addEventListener('load', () => {
    updateChart();
});
</script>

{% endblock %}
